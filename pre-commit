#! /bin/sh

findFilesChanged(){
    git diff --staged --name-only
}

findChanges(){
    KEY_PATTERN="([^A-Z0-9]|^)[A-Z0-9]{20}([^A-Z0-9]|$)"
    SECRET_PATTERN="([^A-Za-z0-9/+=]|^)[A-Za-z0-9/+=]{40}([^A-Za-z0-9/+=]|$)"
    EQUALS_SECRET_PATTERN="=[A-Za-z0-9/+]{40}([^A-Za-z0-9/+]|$)"

    while read file; do
        if [ -n "$file" ]; then
            egrep -n "($KEY_PATTERN|$SECRET_PATTERN|$EQUALS_SECRET_PATTERN)" "$file" 
        fi
    done
}

report(){
    read credentials

    if [ -n "$credentials" ]; then
        echo "AWS credentials found. Aborting commit."
        echo $credentials
        exit 1
    else
        exit 0
    fi
}

findFilesChanged | findChanges | report
