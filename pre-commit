#! /bin/sh

findFilesChanged(){
    git diff --staged --name-only | tr '\n' ' '
}

findChanges(){
    read files

    KEY_PATTERN="([^A-Z0-9]|^)[A-Z0-9]{20}([^A-Z0-9]|$)"
    SECRET_PATTERN="([^A-Za-z0-9/+]|^)[A-Za-z0-9/+=]{40}([^A-Za-z0-9/+=]|$)"

    if [ -n "$files" ]; then
        egrep -n "($KEY_PATTERN|$SECRET_PATTERN)" $files 
    else
        echo ""
    fi
}

report(){
    read credentials

    if [ -n "$credentials" ]; then
        echo "AWS credentials found:"
        echo $credentials
        while read credentials; do
            echo $credentials
        done
        exit 1
    else
        exit 0
    fi
}

confirmAction(){
    if [ $1 -ne 0 ]; then
        read -p "Commit anyway? (y/N)" answer
        case $answer in
            "n" | "N" | "") exit 1;;
            "y" | "Y" ) exit 0;;
        esac
        while read -p "Please answer y/N" answer; do
            case $answer in
	        "n" | "N" | "") exit 1;;
                "y" | "Y" ) exit 0;;
            esac
        done
    fi    
}

findFilesChanged | findChanges | report
